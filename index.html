<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evaluate Function Calls on HPC Schedulers (LSF, SGE, SLURM, PBS/Torque) • clustermq</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Evaluate Function Calls on HPC Schedulers (LSF, SGE, SLURM, PBS/Torque)">
<meta property="og:description" content="Evaluate arbitrary function calls using workers on HPC schedulers
    in single line of code. All processing is done on the network without
    accessing the file system. Remote schedulers are supported via SSH.">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">clustermq</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.8.9</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="articles/userguide.html">User Guide</a>
</li>
<li>
  <a href="articles/technicaldocs.html">Technical Documentation</a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mschubert/clustermq">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div id="clustermq-send-r-function-calls-as-cluster-jobs" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#clustermq-send-r-function-calls-as-cluster-jobs" class="anchor"></a>ClusterMQ: send R function calls as cluster jobs</h1></div>

<p>This package will allow you to send function calls as jobs on a computing cluster with a minimal interface provided by the <code>Q</code> function:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># load the library and create a simple function</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(clustermq)</span>
<span id="cb1-3"><a href="#cb1-3"></a>fx =<span class="st"> </span><span class="cf">function</span>(x) x <span class="op">*</span><span class="st"> </span><span class="dv">2</span></span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co"># queue the function call on your scheduler</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="kw"><a href="reference/Q.html">Q</a></span>(fx, <span class="dt">x=</span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">n_jobs=</span><span class="dv">1</span>)</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="co"># list(2,4,6)</span></span></code></pre></div>
<p>Computations are done <a href="https://github.com/armstrtw/rzmq">entirely on the network</a> and without any temporary files on network-mounted storage, so there is no strain on the file system apart from starting up R once per job. All calculations are load-balanced, i.e. workers that get their jobs done faster will also receive more function calls to work on. This is especially useful if not all calls return after the same time, or one worker has a high load.</p>
<p>Browse the vignettes here:</p>
<ul>
<li><a href="https://mschubert.github.io/clustermq/articles/userguide.html">User Guide</a></li>
<li><a href="https://mschubert.github.io/clustermq/articles/technicaldocs.html">Technical Documentation</a></li>
</ul>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>First, we need the <a href="https://github.com/ropensci/rzmq#installation">ZeroMQ</a> system library. Most likely, your package manager will provide this:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># You can skip this step on Windows and macOS, the rzmq binary has it</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co"># On a computing cluster, we recommend to use Conda or Linuxbrew</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="ex">brew</span> install zeromq <span class="co"># Linuxbrew, Homebrew on macOS</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="ex">conda</span> install zeromq <span class="co"># Conda</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="fu">sudo</span> apt-get install libzmq3-dev <span class="co"># Ubuntu</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="fu">sudo</span> yum install zeromq-devel <span class="co"># Fedora</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="ex">pacman</span> -S zeromq <span class="co"># Arch Linux</span></span></code></pre></div>
<p>Then install the <code>clustermq</code> package in R (which automatically installs the <code>rzmq</code> package as well) from CRAN:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">'clustermq'</span>)</span></code></pre></div>
<p>Alternatively you can use <code>devtools</code> to install directly from Github:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># install.packages('devtools')</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>devtools<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/devtools/man/remote-reexports.html">install_github</a></span>(<span class="st">'mschubert/clustermq'</span>)</span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co"># devtools::install_github('mschubert/clustermq', ref="develop") # dev version</span></span></code></pre></div>
</div>
<div id="schedulers" class="section level2">
<h2 class="hasAnchor">
<a href="#schedulers" class="anchor"></a>Schedulers</h2>
<p>An HPC cluster’s scheduler ensures that computing jobs are distributed to available worker nodes. Hence, this is what clustermq interfaces with in order to do computations.</p>
<p>We currently support the <a href="https://mschubert.github.io/clustermq/articles/userguide.html#setting-up-the-scheduler">following schedulers</a> (either locally or via SSH):</p>
<ul>
<li>
<a href="https://mschubert.github.io/clustermq/articles/userguide.html#lsf">LSF</a> - <em>should work without setup</em>
</li>
<li>
<a href="https://mschubert.github.io/clustermq/articles/userguide.html#sge">SGE</a> - <em>should work without setup</em>
</li>
<li>
<a href="https://mschubert.github.io/clustermq/articles/userguide.html#slurm">SLURM</a> - <em>should work without setup</em>
</li>
<li>
<a href="https://mschubert.github.io/clustermq/articles/userguide.html#pbs">PBS</a>/<a href="https://mschubert.github.io/clustermq/articles/userguide.html#torque">Torque</a> - <em>needs</em> <code><a href="https://rdrr.io/r/base/options.html">options(clustermq.scheduler="PBS"/"Torque")</a></code>
</li>
<li>via <a href="https://mschubert.github.io/clustermq/articles/userguide.html#ssh-connector">SSH</a> - <em>needs</em> <code>options(clustermq.scheduler="ssh", clustermq.ssh.host=&lt;yourhost&gt;)</code>
</li>
</ul>
<p>Each scheduler will be interfaced <a href="https://mschubert.github.io/clustermq/articles/userguide.html">using a default template that can be customized.</a></p>
<p>If you need specific <a href="https://mschubert.github.io/clustermq/articles/userguide.html#environments">computing environments or containers</a>, you can activate them via the scheduler template.</p>
</div>
<div id="usage" class="section level2">
<h2 class="hasAnchor">
<a href="#usage" class="anchor"></a>Usage</h2>
<p>The most common arguments for <code>Q</code> are:</p>
<ul>
<li>
<code>fun</code> - The function to call. This needs to be self-sufficient (because it will not have access to the <code>master</code> environment)</li>
<li>
<code>...</code> - All iterated arguments passed to the function. If there is more than one, all of them need to be named</li>
<li>
<code>const</code> - A named list of non-iterated arguments passed to <code>fun</code>
</li>
<li>
<code>export</code> - A named list of objects to export to the worker environment</li>
</ul>
<p>The documentation for other arguments can be accessed by typing <code><a href="reference/Q.html">?Q</a></code>. Examples of using <code>const</code> and <code>export</code> would be:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># adding a constant argument</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>fx =<span class="st"> </span><span class="cf">function</span>(x, y) x <span class="op">*</span><span class="st"> </span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>y</span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="kw"><a href="reference/Q.html">Q</a></span>(fx, <span class="dt">x=</span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">const=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">y=</span><span class="dv">10</span>), <span class="dt">n_jobs=</span><span class="dv">1</span>)</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># exporting an object to workers</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>fx =<span class="st"> </span><span class="cf">function</span>(x) x <span class="op">*</span><span class="st"> </span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>y</span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="kw"><a href="reference/Q.html">Q</a></span>(fx, <span class="dt">x=</span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">export=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">y=</span><span class="dv">10</span>), <span class="dt">n_jobs=</span><span class="dv">1</span>)</span></code></pre></div>
<p><code>clustermq</code> can also be used as a parallel backend for <a href="https://cran.r-project.org/package=foreach"><code>foreach</code></a>. As this is also used by <a href="http://bioconductor.org/packages/release/bioc/html/BiocParallel.html"><code>BiocParallel</code></a>, we can run those packages on the cluster as well:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(foreach)</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="kw"><a href="reference/register_dopar_cmq.html">register_dopar_cmq</a></span>(<span class="dt">n_jobs=</span><span class="dv">2</span>, <span class="dt">memory=</span><span class="dv">1024</span>) <span class="co"># accepts same arguments as `workers`</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="kw"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span>(<span class="dt">i=</span><span class="dv">1</span><span class="op">:</span><span class="dv">3</span>) <span class="op">%dopar%</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(i) <span class="co"># this will be executed as jobs</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(BiocParallel)</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="kw"><a href="https://rdrr.io/pkg/BiocParallel/man/register.html">register</a></span>(<span class="kw"><a href="https://rdrr.io/pkg/BiocParallel/man/DoparParam-class.html">DoparParam</a></span>()) <span class="co"># after register_dopar_cmq(...)</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="kw"><a href="https://rdrr.io/pkg/BiocParallel/man/bplapply.html">bplapply</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, sqrt)</span></code></pre></div>
<p>More examples are available in <a href="https://mschubert.github.io/clustermq/articles/userguide.html">the user guide</a>.</p>
</div>
<div id="comparison-to-other-packages" class="section level2">
<h2 class="hasAnchor">
<a href="#comparison-to-other-packages" class="anchor"></a>Comparison to other packages</h2>
<p>There are some packages that provide high-level parallelization of R function calls on a computing cluster. We compared <code>clustermq</code> to <code>BatchJobs</code> and <code>batchtools</code> for processing many short-running jobs, and found it to have approximately 1000x less overhead cost.</p>
<p><img src="http://image.ibb.co/cRgYNR/plot.png" alt="Overhead comparison"></p>
<p>In short, use <code>clustermq</code> if you want:</p>
<ul>
<li>a one-line solution to run cluster jobs with minimal setup</li>
<li>access cluster functions from your local Rstudio via SSH</li>
<li>fast processing of many function calls without network storage I/O</li>
</ul>
<p>Use <a href="https://github.com/mllg/batchtools"><code>batchtools</code></a> if you:</p>
<ul>
<li>want to use a mature and well-tested package</li>
<li>don’t mind that arguments to every call are written to/read from disc</li>
<li>don’t mind there’s no load-balancing at run-time</li>
</ul>
<p>Use <a href="https://snakemake.readthedocs.io/en/latest/">Snakemake</a> or <a href="https://github.com/ropensci/drake"><code>drake</code></a> if:</p>
<ul>
<li>you want to design and run a workflow on HPC</li>
</ul>
<p>Don’t use <a href="https://cran.r-project.org/web/packages/batch/index.html"><code>batch</code></a> (last updated 2013) or <a href="https://github.com/tudo-r/BatchJobs"><code>BatchJobs</code></a> (issues with SQLite on network-mounted storage).</p>
</div>
<div id="citation" class="section level2">
<h2 class="hasAnchor">
<a href="#citation" class="anchor"></a>Citation</h2>
<p>This project is part of my academic work, for which I will be evaluated on citations. If you like me to be able to continue working on research support tools like <code>clustermq</code>, please cite the article when using it for publications:</p>
<blockquote>
<p>M Schubert. clustermq enables efficient parallelisation of genomic analyses. <em>Bioinformatics</em> (2019). <a href="https://doi.org/10.1093/bioinformatics/btz284">doi:10.1093/bioinformatics/btz284</a></p>
</blockquote>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Download from CRAN at <br><a href="https://cloud.r-project.org/package=clustermq">https://​cloud.r-project.org/​package=clustermq</a>
</li>
<li>Browse source code at <br><a href="https://github.com/mschubert/clustermq">https://​github.com/​mschubert/​clustermq</a>
</li>
<li>Report a bug at <br><a href="https://github.com/mschubert/clustermq/issues">https://​github.com/​mschubert/​clustermq/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li>Apache License (== 2.0) | file <a href="LICENSE-text.html">LICENSE</a>
</li>
</ul>
</div>
<div class="citation">
<h2>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html">Citing clustermq</a></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Michael Schubert <br><small class="roles"> Author, maintainer, copyright holder </small> <a href="https://orcid.org/0000-0002-6862-5221" target="orcid.widget"><img src="https://members.orcid.org/sites/default/files/vector_iD_icon.svg" class="orcid" alt="ORCID"></a> </li>
</ul>
</div>

  <div class="dev-status">
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://cran.r-project.org/package=clustermq"><img src="http://www.r-pkg.org/badges/version/clustermq" alt="CRAN version"></a></li>
<li><a href="https://travis-ci.org/mschubert/clustermq"><img src="https://travis-ci.org/mschubert/clustermq.svg?branch=master" alt="Build Status"></a></li>
<li><a href="http://cran.rstudio.com/web/packages/clustermq/index.html"><img src="http://cranlogs.r-pkg.org/badges/clustermq" alt="CRAN downloads"></a></li>
<li><a href="https://doi.org/10.1093/bioinformatics/btz284"><img src="https://zenodo.org/badge/DOI/10.1093/bioinformatics/btz284.svg" alt="DOI"></a></li>
</ul>
</div>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by Michael Schubert.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
